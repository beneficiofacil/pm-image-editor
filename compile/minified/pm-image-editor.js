/*! undefined v0.4.0 License: MIT */!function(){"use strict";!function(){angular.module("pmImageCrop",[]),angular.module("pmImageEditor",[])}(),function(){angular.module("pmImageCrop").factory("cropAreaCircle",["cropArea",function(t){var e=function(){t.apply(this,arguments),this._boxResizeBaseSize=20,this._boxResizeNormalRatio=.9,this._boxResizeHoverRatio=1.2,this._iconMoveNormalRatio=.9,this._iconMoveHoverRatio=1.2,this._boxResizeNormalSize=this._boxResizeBaseSize*this._boxResizeNormalRatio,this._boxResizeHoverSize=this._boxResizeBaseSize*this._boxResizeHoverRatio,this._posDragStartX=0,this._posDragStartY=0,this._posResizeStartX=0,this._posResizeStartY=0,this._posResizeStartSize=0,this._boxResizeIsHover=!1,this._areaIsHover=!1,this._boxResizeIsDragging=!1,this._areaIsDragging=!1};return e.prototype=new t,e.prototype._calcCirclePerimeterCoords=function(t){var e=this._size/2,i=t*(Math.PI/180),s=this._x+e*Math.cos(i),o=this._y+e*Math.sin(i);return[s,o]},e.prototype._calcResizeIconCenterCoords=function(){return this._calcCirclePerimeterCoords(-45)},e.prototype._isCoordWithinArea=function(t){return Math.sqrt((t[0]-this._x)*(t[0]-this._x)+(t[1]-this._y)*(t[1]-this._y))<this._size/2},e.prototype._isCoordWithinBoxResize=function(t){var e=this._calcResizeIconCenterCoords(),i=this._boxResizeHoverSize/2;return t[0]>e[0]-i&&t[0]<e[0]+i&&t[1]>e[1]-i&&t[1]<e[1]+i},e.prototype._drawArea=function(t,e,i){t.arc(e[0],e[1],i/2,0,2*Math.PI)},e.prototype.draw=function(){t.prototype.draw.apply(this,arguments),this._cropCanvas.drawIconMove([this._x,this._y],this._areaIsHover?this._iconMoveHoverRatio:this._iconMoveNormalRatio),this._cropCanvas.drawIconResizeBoxNESW(this._calcResizeIconCenterCoords(),this._boxResizeBaseSize,this._boxResizeIsHover?this._boxResizeHoverRatio:this._boxResizeNormalRatio)},e.prototype.processMouseMove=function(t,e){var i="default",s=!1;if(this._boxResizeIsHover=!1,this._areaIsHover=!1,this._areaIsDragging)this._x=t-this._posDragStartX,this._y=e-this._posDragStartY,this._areaIsHover=!0,i="move",s=!0,this._events.trigger("area-move");else if(this._boxResizeIsDragging){i="nesw-resize";var o,r,n;r=t-this._posResizeStartX,n=this._posResizeStartY-e,o=r>n?this._posResizeStartSize+2*n:this._posResizeStartSize+2*r,this._size=Math.max(this._minSize,o),this._boxResizeIsHover=!0,s=!0,this._events.trigger("area-resize")}else this._isCoordWithinBoxResize([t,e])?(i="nesw-resize",this._areaIsHover=!1,this._boxResizeIsHover=!0,s=!0):this._isCoordWithinArea([t,e])&&(i="move",this._areaIsHover=!0,s=!0);return this._dontDragOutside(),angular.element(this._ctx.canvas).css({cursor:i}),s},e.prototype.processMouseDown=function(t,e){this._isCoordWithinBoxResize([t,e])?(this._areaIsDragging=!1,this._areaIsHover=!1,this._boxResizeIsDragging=!0,this._boxResizeIsHover=!0,this._posResizeStartX=t,this._posResizeStartY=e,this._posResizeStartSize=this._size,this._events.trigger("area-resize-start")):this._isCoordWithinArea([t,e])&&(this._areaIsDragging=!0,this._areaIsHover=!0,this._boxResizeIsDragging=!1,this._boxResizeIsHover=!1,this._posDragStartX=t-this._x,this._posDragStartY=e-this._y,this._events.trigger("area-move-start"))},e.prototype.processMouseUp=function(){this._areaIsDragging&&(this._areaIsDragging=!1,this._events.trigger("area-move-end")),this._boxResizeIsDragging&&(this._boxResizeIsDragging=!1,this._events.trigger("area-resize-end")),this._areaIsHover=!1,this._boxResizeIsHover=!1,this._posDragStartX=0,this._posDragStartY=0},e}])}(),function(){angular.module("pmImageCrop").factory("cropAreaSquare",["cropArea",function(t){var e=function(){t.apply(this,arguments),this._resizeCtrlBaseRadius=10,this._resizeCtrlNormalRatio=.75,this._resizeCtrlHoverRatio=1,this._iconMoveNormalRatio=.9,this._iconMoveHoverRatio=1.2,this._resizeCtrlNormalRadius=this._resizeCtrlBaseRadius*this._resizeCtrlNormalRatio,this._resizeCtrlHoverRadius=this._resizeCtrlBaseRadius*this._resizeCtrlHoverRatio,this._posDragStartX=0,this._posDragStartY=0,this._posResizeStartX=0,this._posResizeStartY=0,this._posResizeStartSize=0,this._resizeCtrlIsHover=-1,this._areaIsHover=!1,this._resizeCtrlIsDragging=-1,this._areaIsDragging=!1};return e.prototype=new t,e.prototype._calcSquareCorners=function(){var t=this._size/2;return[[this._x-t,this._y-t],[this._x+t,this._y-t],[this._x-t,this._y+t],[this._x+t,this._y+t]]},e.prototype._calcSquareDimensions=function(){var t=this._size/2;return{left:this._x-t,top:this._y-t,right:this._x+t,bottom:this._y+t}},e.prototype._isCoordWithinArea=function(t){var e=this._calcSquareDimensions();return t[0]>=e.left&&t[0]<=e.right&&t[1]>=e.top&&t[1]<=e.bottom},e.prototype._isCoordWithinResizeCtrl=function(t){for(var e=this._calcSquareCorners(),i=-1,s=0,o=e.length;o>s;s++){var r=e[s];if(t[0]>r[0]-this._resizeCtrlHoverRadius&&t[0]<r[0]+this._resizeCtrlHoverRadius&&t[1]>r[1]-this._resizeCtrlHoverRadius&&t[1]<r[1]+this._resizeCtrlHoverRadius){i=s;break}}return i},e.prototype._drawArea=function(t,e,i){var s=i/2;t.rect(e[0]-s,e[1]-s,i,i)},e.prototype.draw=function(){t.prototype.draw.apply(this,arguments),this._cropCanvas.drawIconMove([this._x,this._y],this._areaIsHover?this._iconMoveHoverRatio:this._iconMoveNormalRatio);for(var e=this._calcSquareCorners(),i=0,s=e.length;s>i;i++){var o=e[i];this._cropCanvas.drawIconResizeCircle(o,this._resizeCtrlBaseRadius,this._resizeCtrlIsHover===i?this._resizeCtrlHoverRatio:this._resizeCtrlNormalRatio)}},e.prototype.processMouseMove=function(t,e){var i="default",s=!1;if(this._resizeCtrlIsHover=-1,this._areaIsHover=!1,this._areaIsDragging)this._x=t-this._posDragStartX,this._y=e-this._posDragStartY,this._areaIsHover=!0,i="move",s=!0,this._events.trigger("area-move");else if(this._resizeCtrlIsDragging>-1){var o,r;switch(this._resizeCtrlIsDragging){case 0:o=-1,r=-1,i="nwse-resize";break;case 1:o=1,r=-1,i="nesw-resize";break;case 2:o=-1,r=1,i="nesw-resize";break;case 3:o=1,r=1,i="nwse-resize"}var n,a=(t-this._posResizeStartX)*o,h=(e-this._posResizeStartY)*r;n=a>h?this._posResizeStartSize+h:this._posResizeStartSize+a;var l=this._size;this._size=Math.max(this._minSize,n);var u=(this._size-l)/2;this._x+=u*o,this._y+=u*r,this._resizeCtrlIsHover=this._resizeCtrlIsDragging,s=!0,this._events.trigger("area-resize")}else{var c=this._isCoordWithinResizeCtrl([t,e]);if(c>-1){switch(c){case 0:i="nwse-resize";break;case 1:i="nesw-resize";break;case 2:i="nesw-resize";break;case 3:i="nwse-resize"}this._areaIsHover=!1,this._resizeCtrlIsHover=c,s=!0}else this._isCoordWithinArea([t,e])&&(i="move",this._areaIsHover=!0,s=!0)}return this._dontDragOutside(),angular.element(this._ctx.canvas).css({cursor:i}),s},e.prototype.processMouseDown=function(t,e){var i=this._isCoordWithinResizeCtrl([t,e]);i>-1?(this._areaIsDragging=!1,this._areaIsHover=!1,this._resizeCtrlIsDragging=i,this._resizeCtrlIsHover=i,this._posResizeStartX=t,this._posResizeStartY=e,this._posResizeStartSize=this._size,this._events.trigger("area-resize-start")):this._isCoordWithinArea([t,e])&&(this._areaIsDragging=!0,this._areaIsHover=!0,this._resizeCtrlIsDragging=-1,this._resizeCtrlIsHover=-1,this._posDragStartX=t-this._x,this._posDragStartY=e-this._y,this._events.trigger("area-move-start"))},e.prototype.processMouseUp=function(){this._areaIsDragging&&(this._areaIsDragging=!1,this._events.trigger("area-move-end")),this._resizeCtrlIsDragging>-1&&(this._resizeCtrlIsDragging=-1,this._events.trigger("area-resize-end")),this._areaIsHover=!1,this._resizeCtrlIsHover=-1,this._posDragStartX=0,this._posDragStartY=0},e}])}(),function(){angular.module("pmImageCrop").factory("cropArea",["cropCanvas",function(t){var e=function(e,i){this._ctx=e,this._events=i,this._minSize=80,this._cropCanvas=new t(e),this._image=new Image,this._x=0,this._y=0,this._size=200};return e.prototype.getImage=function(){return this._image},e.prototype.setImage=function(t){this._image=t},e.prototype.getX=function(){return this._x},e.prototype.setX=function(t){this._x=t,this._dontDragOutside()},e.prototype.getY=function(){return this._y},e.prototype.setY=function(t){this._y=t,this._dontDragOutside()},e.prototype.getSize=function(){return this._size},e.prototype.setSize=function(t){this._size=Math.max(this._minSize,t),this._dontDragOutside()},e.prototype.getMinSize=function(){return this._minSize},e.prototype.setMinSize=function(t){this._minSize=t,this._size=Math.max(this._minSize,this._size),this._dontDragOutside()},e.prototype._dontDragOutside=function(){var t=this._ctx.canvas.height,e=this._ctx.canvas.width;this._size>e&&(this._size=e),this._size>t&&(this._size=t),this._x<this._size/2&&(this._x=this._size/2),this._x>e-this._size/2&&(this._x=e-this._size/2),this._y<this._size/2&&(this._y=this._size/2),this._y>t-this._size/2&&(this._y=t-this._size/2)},e.prototype._drawArea=function(){},e.prototype.draw=function(){this._cropCanvas.drawCropArea(this._image,[this._x,this._y],this._size,this._drawArea)},e.prototype.processMouseMove=function(){},e.prototype.processMouseDown=function(){},e.prototype.processMouseUp=function(){},e}])}(),function(){angular.module("pmImageCrop").factory("cropCanvas",[function(){var t=[[-.5,-2],[-3,-4.5],[-.5,-7],[-7,-7],[-7,-.5],[-4.5,-3],[-2,-.5]],e=[[.5,-2],[3,-4.5],[.5,-7],[7,-7],[7,-.5],[4.5,-3],[2,-.5]],i=[[-.5,2],[-3,4.5],[-.5,7],[-7,7],[-7,.5],[-4.5,3],[-2,.5]],s=[[.5,2],[3,4.5],[.5,7],[7,7],[7,.5],[4.5,3],[2,.5]],o=[[-1.5,-2.5],[-1.5,-6],[-5,-6],[0,-11],[5,-6],[1.5,-6],[1.5,-2.5]],r=[[-2.5,-1.5],[-6,-1.5],[-6,-5],[-11,0],[-6,5],[-6,1.5],[-2.5,1.5]],n=[[-1.5,2.5],[-1.5,6],[-5,6],[0,11],[5,6],[1.5,6],[1.5,2.5]],a=[[2.5,-1.5],[6,-1.5],[6,-5],[11,0],[6,5],[6,1.5],[2.5,1.5]],h={areaOutline:"#fff",resizeBoxStroke:"#fff",resizeBoxFill:"#444",resizeBoxArrowFill:"#fff",resizeCircleStroke:"#fff",resizeCircleFill:"#444",moveIconFill:"#fff"};return function(l){var u=function(t,e,i){return[i*t[0]+e[0],i*t[1]+e[1]]},c=function(t,e,i,s){l.save(),l.fillStyle=e,l.beginPath();var o,r=u(t[0],i,s);l.moveTo(r[0],r[1]);for(var n in t)n>0&&(o=u(t[n],i,s),l.lineTo(o[0],o[1]));l.lineTo(r[0],r[1]),l.fill(),l.closePath(),l.restore()};this.drawIconMove=function(t,e){c(o,h.moveIconFill,t,e),c(r,h.moveIconFill,t,e),c(n,h.moveIconFill,t,e),c(a,h.moveIconFill,t,e)},this.drawIconResizeCircle=function(t,e,i){var s=e*i;l.save(),l.strokeStyle=h.resizeCircleStroke,l.lineWidth=2,l.fillStyle=h.resizeCircleFill,l.beginPath(),l.arc(t[0],t[1],s,0,2*Math.PI),l.fill(),l.stroke(),l.closePath(),l.restore()},this.drawIconResizeBoxBase=function(t,e,i){var s=e*i;l.save(),l.strokeStyle=h.resizeBoxStroke,l.lineWidth=2,l.fillStyle=h.resizeBoxFill,l.fillRect(t[0]-s/2,t[1]-s/2,s,s),l.strokeRect(t[0]-s/2,t[1]-s/2,s,s),l.restore()},this.drawIconResizeBoxNESW=function(t,s,o){this.drawIconResizeBoxBase(t,s,o),c(e,h.resizeBoxArrowFill,t,o),c(i,h.resizeBoxArrowFill,t,o)},this.drawIconResizeBoxNWSE=function(e,i,o){this.drawIconResizeBoxBase(e,i,o),c(t,h.resizeBoxArrowFill,e,o),c(s,h.resizeBoxArrowFill,e,o)},this.drawCropArea=function(t,e,i,s){var o=t.width/l.canvas.width,r=t.height/l.canvas.height,n=e[0]-i/2,a=e[1]-i/2;l.save(),l.strokeStyle=h.areaOutline,l.lineWidth=2,l.beginPath(),s(l,e,i),l.stroke(),l.clip(),i>0&&l.drawImage(t,n*o,a*r,i*o,i*r,n,a,i,i),l.beginPath(),s(l,e,i),l.stroke(),l.clip(),l.restore()}}}])}(),function(){angular.module("pmImageCrop").service("cropEXIF",[function(){function t(t){return!!t.exifdata}function e(t,e){e=e||t.match(/^data\:([^\;]+)\;base64,/im)[1]||"",t=t.replace(/^data\:([^\;]+)\;base64,/gim,"");for(var i=atob(t),s=i.length,o=new ArrayBuffer(s),r=new Uint8Array(o),n=0;s>n;n++)r[n]=i.charCodeAt(n);return o}function i(t,e){var i=new XMLHttpRequest;i.open("GET",t,!0),i.responseType="blob",i.onload=function(){(200===this.status||0===this.status)&&e(this.response)},i.send()}function s(t,e,i){for(var s="",o=e;e+i>o;o++)s+=String.fromCharCode(t.getUint8(o));return s}function o(t,e,i,o,r){var n,a,h,l,u,c,p=t.getUint16(e+2,!r),g=t.getUint32(e+4,!r),d=t.getUint32(e+8,!r)+i;switch(p){case 1:case 7:if(1===g)return t.getUint8(e+8,!r);for(n=g>4?d:e+8,a=[],l=0;g>l;l++)a[l]=t.getUint8(n+l);return a;case 2:return n=g>4?d:e+8,s(t,n,g-1);case 3:if(1===g)return t.getUint16(e+8,!r);for(n=g>2?d:e+8,a=[],l=0;g>l;l++)a[l]=t.getUint16(n+2*l,!r);return a;case 4:if(1===g)return t.getUint32(e+8,!r);for(a=[],l=0;g>l;l++)a[l]=t.getUint32(d+4*l,!r);return a;case 5:if(1===g)return u=t.getUint32(d,!r),c=t.getUint32(d+4,!r),h=new Number(u/c),h.numerator=u,h.denominator=c,h;for(a=[],l=0;g>l;l++)u=t.getUint32(d+8*l,!r),c=t.getUint32(d+4+8*l,!r),a[l]=new Number(u/c),a[l].numerator=u,a[l].denominator=c;return a;case 9:if(1===g)return t.getInt32(e+8,!r);for(a=[],l=0;g>l;l++)a[l]=t.getInt32(d+4*l,!r);return a;case 10:if(1===g)return t.getInt32(d,!r)/t.getInt32(d+4,!r);for(a=[],l=0;g>l;l++)a[l]=t.getInt32(d+8*l,!r)/t.getInt32(d+4+8*l,!r);return a}}function r(t,e,i,s,r){var n,a,h,l=t.getUint16(i,!r),u={};for(h=0;l>h;h++)n=i+12*h+2,a=s[t.getUint16(n,!r)],!a&&c&&console.log("Unknown tag: "+t.getUint16(n,!r)),u[a]=o(t,n,e,i,r);return u}function n(t,e){if("Exif"!==s(t,e,4))return c&&console.log("Not valid EXIF data! "+s(t,e,4)),!1;var i,o,n,a,h,l=e+6;if(18761===t.getUint16(l))i=!1;else{if(19789!==t.getUint16(l))return c&&console.log("Not valid TIFF data! (no 0x4949 or 0x4D4D)"),!1;i=!0}if(42!==t.getUint16(l+2,!i))return c&&console.log("Not valid TIFF data! (no 0x002A)"),!1;var u=t.getUint32(l+4,!i);if(8>u)return c&&console.log("Not valid TIFF data! (First offset less than 8)",t.getUint32(l+4,!i)),!1;if(o=r(t,l,l+u,g,i),o.ExifIFDPointer){a=r(t,l,l+o.ExifIFDPointer,p,i);for(n in a)if(a.hasOwnProperty(n)){switch(n){case"LightSource":case"Flash":case"MeteringMode":case"ExposureProgram":case"SensingMethod":case"SceneCaptureType":case"SceneType":case"CustomRendered":case"WhiteBalance":case"GainControl":case"Contrast":case"Saturation":case"Sharpness":case"SubjectDistanceRange":case"FileSource":a[n]=f[n][a[n]];break;case"ExifVersion":case"FlashpixVersion":a[n]=String.fromCharCode(a[n][0],a[n][1],a[n][2],a[n][3]);break;case"ComponentsConfiguration":a[n]=f.Components[a[n][0]]+f.Components[a[n][1]]+f.Components[a[n][2]]+f.Components[a[n][3]]}o[n]=a[n]}}if(o.GPSInfoIFDPointer){h=r(t,l,l+o.GPSInfoIFDPointer,d,i);for(n in h)if(h.hasOwnProperty(n)){switch(n){case"GPSVersionID":h[n]=h[n][0]+"."+h[n][1]+"."+h[n][2]+"."+h[n][3]}o[n]=h[n]}}return o}function a(t){var e=new DataView(t);if(c&&console.log("Got file of length "+t.byteLength),255!==e.getUint8(0)||216!==e.getUint8(1))return c&&console.log("Not a valid JPEG"),!1;for(var i,s=2,o=t.byteLength;o>s;){if(255!==e.getUint8(s))return c&&console.log("Not a valid marker at offset "+s+", found: "+e.getUint8(s)),!1;if(i=e.getUint8(s+1),c&&console.log(i),225===i)return c&&console.log("Found 0xFFE1 marker"),n(e,s+4,e.getUint16(s+2)-2);s+=2+e.getUint16(s+2)}}function h(t,e,i){for(var o,r,n,a,h,l=new DataView(t),u={},c=e;e+i>c;)28===l.getUint8(c)&&2===l.getUint8(c+1)&&(a=l.getUint8(c+2),a in _&&(n=l.getInt16(c+3),h=n+5,r=_[a],o=s(l,c+5,n),u.hasOwnProperty(r)?u[r]instanceof Array?u[r].push(o):u[r]=[u[r],o]:u[r]=o)),c++;return u}function l(t){var e=new DataView(t);if(c&&console.log("Got file of length "+t.byteLength),255!==e.getUint8(0)||216!==e.getUint8(1))return c&&console.log("Not a valid JPEG"),!1;for(var i=2,s=t.byteLength,o=function(t,e){return 56===t.getUint8(e)&&66===t.getUint8(e+1)&&73===t.getUint8(e+2)&&77===t.getUint8(e+3)&&4===t.getUint8(e+4)&&4===t.getUint8(e+5)};s>i;){if(o(e,i)){var r=e.getUint8(i+7);r%2!==0&&(r+=1),0===r&&(r=4);var n=i+8+r,a=e.getUint16(i+6+r);return h(t,n,a)}i++}}function u(t,s){function o(e){var i=a(e),o=l(e);t.exifdata=i||{},t.iptcdata=o||{},s&&s.call(t)}var r;if(t.src)if(/^data\:/i.test(t.src)){var n=e(t.src);o(n)}else if(/^blob\:/i.test(t.src))r=new FileReader,r.onload=function(t){o(t.target.result)},i(t.src,function(t){r.readAsArrayBuffer(t)});else{var h=new XMLHttpRequest;h.onload=function(){if(200!==this.status&&0!==this.status)throw"Could not load image";o(h.response),h=null},h.open("GET",t.src,!0),h.responseType="arraybuffer",h.send(null)}else window.FileReader&&(t instanceof window.Blob||t instanceof window.File)&&(r=new FileReader,r.onload=function(t){c&&console.log("Got file of length "+t.target.result.byteLength),o(t.target.result)},r.readAsArrayBuffer(t))}var c=!1,p=this.Tags={36864:"ExifVersion",40960:"FlashpixVersion",40961:"ColorSpace",40962:"PixelXDimension",40963:"PixelYDimension",37121:"ComponentsConfiguration",37122:"CompressedBitsPerPixel",37500:"MakerNote",37510:"UserComment",40964:"RelatedSoundFile",36867:"DateTimeOriginal",36868:"DateTimeDigitized",37520:"SubsecTime",37521:"SubsecTimeOriginal",37522:"SubsecTimeDigitized",33434:"ExposureTime",33437:"FNumber",34850:"ExposureProgram",34852:"SpectralSensitivity",34855:"ISOSpeedRatings",34856:"OECF",37377:"ShutterSpeedValue",37378:"ApertureValue",37379:"BrightnessValue",37380:"ExposureBias",37381:"MaxApertureValue",37382:"SubjectDistance",37383:"MeteringMode",37384:"LightSource",37385:"Flash",37396:"SubjectArea",37386:"FocalLength",41483:"FlashEnergy",41484:"SpatialFrequencyResponse",41486:"FocalPlaneXResolution",41487:"FocalPlaneYResolution",41488:"FocalPlaneResolutionUnit",41492:"SubjectLocation",41493:"ExposureIndex",41495:"SensingMethod",41728:"FileSource",41729:"SceneType",41730:"CFAPattern",41985:"CustomRendered",41986:"ExposureMode",41987:"WhiteBalance",41988:"DigitalZoomRation",41989:"FocalLengthIn35mmFilm",41990:"SceneCaptureType",41991:"GainControl",41992:"Contrast",41993:"Saturation",41994:"Sharpness",41995:"DeviceSettingDescription",41996:"SubjectDistanceRange",40965:"InteroperabilityIFDPointer",42016:"ImageUniqueID"},g=this.TiffTags={256:"ImageWidth",257:"ImageHeight",34665:"ExifIFDPointer",34853:"GPSInfoIFDPointer",40965:"InteroperabilityIFDPointer",258:"BitsPerSample",259:"Compression",262:"PhotometricInterpretation",274:"Orientation",277:"SamplesPerPixel",284:"PlanarConfiguration",530:"YCbCrSubSampling",531:"YCbCrPositioning",282:"XResolution",283:"YResolution",296:"ResolutionUnit",273:"StripOffsets",278:"RowsPerStrip",279:"StripByteCounts",513:"JPEGInterchangeFormat",514:"JPEGInterchangeFormatLength",301:"TransferFunction",318:"WhitePoint",319:"PrimaryChromaticities",529:"YCbCrCoefficients",532:"ReferenceBlackWhite",306:"DateTime",270:"ImageDescription",271:"Make",272:"Model",305:"Software",315:"Artist",33432:"Copyright"},d=this.GPSTags={0:"GPSVersionID",1:"GPSLatitudeRef",2:"GPSLatitude",3:"GPSLongitudeRef",4:"GPSLongitude",5:"GPSAltitudeRef",6:"GPSAltitude",7:"GPSTimeStamp",8:"GPSSatellites",9:"GPSStatus",10:"GPSMeasureMode",11:"GPSDOP",12:"GPSSpeedRef",13:"GPSSpeed",14:"GPSTrackRef",15:"GPSTrack",16:"GPSImgDirectionRef",17:"GPSImgDirection",18:"GPSMapDatum",19:"GPSDestLatitudeRef",20:"GPSDestLatitude",21:"GPSDestLongitudeRef",22:"GPSDestLongitude",23:"GPSDestBearingRef",24:"GPSDestBearing",25:"GPSDestDistanceRef",26:"GPSDestDistance",27:"GPSProcessingMethod",28:"GPSAreaInformation",29:"GPSDateStamp",30:"GPSDifferential"},f=this.StringValues={ExposureProgram:{0:"Not defined",1:"Manual",2:"Normal program",3:"Aperture priority",4:"Shutter priority",5:"Creative program",6:"Action program",7:"Portrait mode",8:"Landscape mode"},MeteringMode:{0:"Unknown",1:"Average",2:"CenterWeightedAverage",3:"Spot",4:"MultiSpot",5:"Pattern",6:"Partial",255:"Other"},LightSource:{0:"Unknown",1:"Daylight",2:"Fluorescent",3:"Tungsten (incandescent light)",4:"Flash",9:"Fine weather",10:"Cloudy weather",11:"Shade",12:"Daylight fluorescent (D 5700 - 7100K)",13:"Day white fluorescent (N 4600 - 5400K)",14:"Cool white fluorescent (W 3900 - 4500K)",15:"White fluorescent (WW 3200 - 3700K)",17:"Standard light A",18:"Standard light B",19:"Standard light C",20:"D55",21:"D65",22:"D75",23:"D50",24:"ISO studio tungsten",255:"Other"},Flash:{0:"Flash did not fire",1:"Flash fired",5:"Strobe return light not detected",7:"Strobe return light detected",9:"Flash fired, compulsory flash mode",13:"Flash fired, compulsory flash mode, return light not detected",15:"Flash fired, compulsory flash mode, return light detected",16:"Flash did not fire, compulsory flash mode",24:"Flash did not fire, auto mode",25:"Flash fired, auto mode",29:"Flash fired, auto mode, return light not detected",31:"Flash fired, auto mode, return light detected",32:"No flash function",65:"Flash fired, red-eye reduction mode",69:"Flash fired, red-eye reduction mode, return light not detected",71:"Flash fired, red-eye reduction mode, return light detected",73:"Flash fired, compulsory flash mode, red-eye reduction mode",77:"Flash fired, compulsory flash mode, red-eye reduction mode, return light not detected",79:"Flash fired, compulsory flash mode, red-eye reduction mode, return light detected",89:"Flash fired, auto mode, red-eye reduction mode",93:"Flash fired, auto mode, return light not detected, red-eye reduction mode",95:"Flash fired, auto mode, return light detected, red-eye reduction mode"},SensingMethod:{1:"Not defined",2:"One-chip color area sensor",3:"Two-chip color area sensor",4:"Three-chip color area sensor",5:"Color sequential area sensor",7:"Trilinear sensor",8:"Color sequential linear sensor"},SceneCaptureType:{0:"Standard",1:"Landscape",2:"Portrait",3:"Night scene"},SceneType:{1:"Directly photographed"},CustomRendered:{0:"Normal process",1:"Custom process"},WhiteBalance:{0:"Auto white balance",1:"Manual white balance"},GainControl:{0:"None",1:"Low gain up",2:"High gain up",3:"Low gain down",4:"High gain down"},Contrast:{0:"Normal",1:"Soft",2:"Hard"},Saturation:{0:"Normal",1:"Low saturation",2:"High saturation"},Sharpness:{0:"Normal",1:"Soft",2:"Hard"},SubjectDistanceRange:{0:"Unknown",1:"Macro",2:"Close view",3:"Distant view"},FileSource:{3:"DSC"},Components:{0:"",1:"Y",2:"Cb",3:"Cr",4:"R",5:"G",6:"B"}},_={120:"caption",110:"credit",25:"keywords",55:"dateCreated",80:"byline",85:"bylineTitle",122:"captionWriter",105:"headline",116:"copyright",15:"category"};this.getData=function(e,i){return(e instanceof Image||e instanceof HTMLImageElement)&&!e.complete?!1:(t(e)?i&&i.call(e):u(e,i),!0)},this.getTag=function(e,i){return t(e)?e.exifdata[i]:void 0},this.getAllTags=function(e){if(!t(e))return{};var i,s=e.exifdata,o={};for(i in s)s.hasOwnProperty(i)&&(o[i]=s[i]);return o},this.pretty=function(e){if(!t(e))return"";var i,s=e.exifdata,o="";for(i in s)s.hasOwnProperty(i)&&(o+="object"==typeof s[i]?s[i]instanceof Number?i+" : "+s[i]+" ["+s[i].numerator+"/"+s[i].denominator+"]\r\n":i+" : ["+s[i].length+" values]\r\n":i+" : "+s[i]+"\r\n");return o},this.readFromBinaryFile=function(t){return a(t)}}])}(),function(){angular.module("pmImageCrop").factory("cropHost",["$document","cropAreaCircle","cropAreaSquare","cropEXIF",function(t,e,i,s){var o=function(t){var e=t.getBoundingClientRect(),i=document.body,s=document.documentElement,o=window.pageYOffset||s.scrollTop||i.scrollTop,r=window.pageXOffset||s.scrollLeft||i.scrollLeft,n=s.clientTop||i.clientTop||0,a=s.clientLeft||i.clientLeft||0,h=e.top+o-n,l=e.left+r-a;return{top:Math.round(h),left:Math.round(l)}};return function(r,n,a){function h(){l.clearRect(0,0,l.canvas.width,l.canvas.height),null!==u&&(l.drawImage(u,0,0,l.canvas.width,l.canvas.height),l.save(),l.fillStyle="rgba(0, 0, 0, 0.65)",l.fillRect(0,0,l.canvas.width,l.canvas.height),l.restore(),c.draw())}var l=null,u=null,c=null,p=[100,100],g=[300,300],d=200,f="image/png",_=null,m=function(){if(null!==u){c.setImage(u);var t=[u.width,u.height],e=u.width/u.height,i=t;i[0]>g[0]?(i[0]=g[0],i[1]=i[0]/e):i[0]<p[0]&&(i[0]=p[0],i[1]=i[0]/e),i[1]>g[1]?(i[1]=g[1],i[0]=i[1]*e):i[1]<p[1]&&(i[1]=p[1],i[0]=i[1]*e),r.prop("width",i[0]).prop("height",i[1]).css({"margin-left":-i[0]/2+"px","margin-top":-i[1]/2+"px"}),c.setX(l.canvas.width/2),c.setY(l.canvas.height/2),c.setSize(Math.min(200,l.canvas.width/2,l.canvas.height/2))}else r.prop("width",0).prop("height",0).css({"margin-top":0});h()},z=function(t){return angular.isDefined(t.changedTouches)?t.changedTouches:t.originalEvent.changedTouches},v=function(t){if(null!==u){var e,i,s=o(l.canvas);"touchmove"===t.type?(e=z(t)[0].pageX,i=z(t)[0].pageY):(e=t.pageX,i=t.pageY),c.processMouseMove(e-s.left,i-s.top),h()}},w=function(t){if(t.preventDefault(),t.stopPropagation(),null!==u){var e,i,s=o(l.canvas);"touchstart"===t.type?(e=z(t)[0].pageX,i=z(t)[0].pageY):(e=t.pageX,i=t.pageY),c.processMouseDown(e-s.left,i-s.top),h()}},y=function(t){if(null!==u){var e,i,s=o(l.canvas);"touchend"===t.type?(e=z(t)[0].pageX,i=z(t)[0].pageY):(e=t.pageX,i=t.pageY),c.processMouseUp(e-s.left,i-s.top),h()}};this.getResultImageDataURI=function(){var t,e;return e=angular.element("<canvas></canvas>")[0],t=e.getContext("2d"),e.width=d,e.height=d,null!==u&&t.drawImage(u,(c.getX()-c.getSize()/2)*(u.width/l.canvas.width),(c.getY()-c.getSize()/2)*(u.height/l.canvas.height),c.getSize()*(u.width/l.canvas.width),c.getSize()*(u.height/l.canvas.height),0,0,d,d),null!==_?e.toDataURL(f,_):e.toDataURL(f)},this.setNewImageSource=function(t){if(u=null,m(),a.trigger("image-updated"),t){var e=new Image;"http"===t.substring(0,4).toLowerCase()&&(e.crossOrigin="anonymous"),e.onload=function(){a.trigger("load-done"),s.getData(e,function(){var t=s.getTag(e,"Orientation");if([3,6,8].indexOf(t)>-1){var i=document.createElement("canvas"),o=i.getContext("2d"),r=e.width,n=e.height,h=0,l=0,c=0;switch(t){case 3:h=-e.width,l=-e.height,c=180;break;case 6:r=e.height,n=e.width,l=-e.height,c=90;break;case 8:r=e.height,n=e.width,h=-e.width,c=270}i.width=r,i.height=n,o.rotate(c*Math.PI/180),o.drawImage(e,h,l),u=new Image,u.src=i.toDataURL("image/png")}else u=e;m(),a.trigger("image-updated")})},e.onerror=function(){a.trigger("load-error")},a.trigger("load-start"),e.src=t}},this.setMaxDimensions=function(t,e){if(g=[t,e],null!==u){var i=l.canvas.width,s=l.canvas.height,o=[u.width,u.height],n=u.width/u.height,a=o;a[0]>g[0]?(a[0]=g[0],a[1]=a[0]/n):a[0]<p[0]&&(a[0]=p[0],a[1]=a[0]/n),a[1]>g[1]?(a[1]=g[1],a[0]=a[1]*n):a[1]<p[1]&&(a[1]=p[1],a[0]=a[1]*n),r.prop("width",a[0]).prop("height",a[1]).css({"margin-left":-a[0]/2+"px","margin-top":-a[1]/2+"px"});var d=l.canvas.width/i,f=l.canvas.height/s,_=Math.min(d,f);c.setX(c.getX()*d),c.setY(c.getY()*f),c.setSize(c.getSize()*_)}else r.prop("width",0).prop("height",0).css({"margin-top":0});h()},this.setAreaMinSize=function(t){t=parseInt(t,10),isNaN(t)||(c.setMinSize(t),h())},this.setResultImageSize=function(t){t=parseInt(t,10),isNaN(t)||(d=t)},this.setResultImageFormat=function(t){f=t},this.setResultImageQuality=function(t){t=parseFloat(t),!isNaN(t)&&t>=0&&1>=t&&(_=t)},this.setAreaType=function(t){var s=c.getSize(),o=c.getMinSize(),r=c.getX(),n=c.getY(),p=e;"square"===t&&(p=i),c=new p(l,a),c.setMinSize(o),c.setSize(s),c.setX(r),c.setY(n),null!==u&&c.setImage(u),h()},l=r[0].getContext("2d"),c=new e(l,a),t.on("mousemove",v),r.on("mousedown",w),t.on("mouseup",y),t.on("touchmove",v),r.on("touchstart",w),t.on("touchend",y),this.destroy=function(){t.off("mousemove",v),r.off("mousedown",w),t.off("mouseup",v),t.off("touchmove",v),r.off("touchstart",w),t.off("touchend",v),r.remove()}}}])}(),function(){angular.module("pmImageCrop").factory("cropPubSub",[function(){return function(){var t={};this.on=function(e,i){return e.split(" ").forEach(function(e){t[e]||(t[e]=[]),t[e].push(i)}),this},this.trigger=function(e,i){return angular.forEach(t[e],function(t){t.call(null,i)}),this}}}])}(),function(){angular.module("pmImageEditor").factory("DraggableFactory",function(){var t=function(){this._originalMousePosition={top:0,left:0},this._position={top:0,left:0},this._size={width:0,height:0},this._parentSize={width:0,height:0}};return t.prototype.css=function(){return{top:this._position.top+"px",left:this._position.left+"px"}},t.prototype.dragStart=function(t,e,i){return this.setPosition(parseInt(e.css("top"),10)||0,parseInt(e.css("left"),10)||0).setOriginalMousePosition(t.screenY,t.screenX).setSize(e).setParentSize(i),this},t.prototype.updatePosition=function(t,e){return this._position.top=Math.max(t-this._originalMousePosition.top,0),this._position.left=Math.max(e-this._originalMousePosition.left,0),this._position.left+this._size.width>this._parentSize.width&&(this._position.left=this._parentSize.width-this._size.width),this._position.top+this._size.height>this._parentSize.height&&(this._position.top=this._parentSize.height-this._size.height),this},t.prototype.setPosition=function(t,e){return this._position={top:t,left:e},this},t.prototype.getPosition=function(){return this._position},t.prototype.setOriginalMousePosition=function(t,e){return this._originalMousePosition={top:t-this._position.top,left:e-this._position.left},this},t.prototype.getOriginalMousePosition=function(){return this._originalMousePosition},t.prototype.setSize=function(t){return this._size={width:parseInt(t.css("width"),10)||t[0].clientWidth,height:parseInt(t.css("height"),10)||t[0].clientHeight},this},t.prototype.getSize=function(){return this._size},t.prototype.setParentSize=function(t){return this._parentSize={width:parseInt(t.css("width"),10)||t[0].clientWidth,height:parseInt(t.css("height"),10)||t[0].clientHeight},this},t.prototype.getParentSize=function(){return this._parentSize},t}).controller("DraggableController",["$scope","$document","$rootScope","DraggableFactory",function(t,e,i,s){t.draggableFactory=new s,t.draggableUiParams=function(){return{element:t.element,position:t.draggableFactory.getPosition()}},t.draggableMousedown=function(i){i.preventDefault(),t.draggableFactory.dragStart(i,t.element,t.parentElement),e.on("mousemove",t.draggableMousemove),e.on("mouseup",t.draggableMouseup)},t.draggableMousemove=function(e){t.draggableFactory.updatePosition(e.screenY,e.screenX),t.element.css(t.draggableFactory.css())},t.draggableMouseup=function(s){e.unbind("mousemove",t.draggableMousemove),e.unbind("mouseup",t.draggableMouseup),i.$broadcast("dragStop",s,t.draggableUiParams())}}]).directive("draggable",function(){return{restrict:"A",controller:"DraggableController",link:function(t,e){t.element=e,t.parentElement=e.parent(),e.css({position:"absolute"}),e.on("mousedown",function(e){t.draggableMousedown(e)})}}})}(),function(){angular.module("pmImageEditor").directive("editorPanel",function(){return{restrict:"E",scope:{editorId:"@"},link:function(t,e){var i="crop,rotate-cw,rotate-acw,flip-h,flip-v,undo,redo",s={};i.split(",").forEach(function(i){s[i]=angular.element('<span class="image-editor-'+i+'" />').on("click",function(){t.$emit("editorButtonClick",{name:i})}),e.append(s[i])}),s.undo.addClass("disabled"),s.redo.addClass("disabled"),t.$on("disableButton",function(e,i,o){i===t.editorId&&s[o].addClass("disabled")}),t.$on("enableButton",function(e,i,o){i===t.editorId&&s[o].removeClass("disabled")})}}})}(),function(){angular.module("pmImageEditor").directive("imageSelection",function(){return{restrict:"E",scope:{editorId:"@",width:"@",height:"@"},link:function(t,e){t.element=e;var i=function(){t.$emit("selectionChanged",t.editorId,{top:parseInt(e.css("top"),10),left:parseInt(e.css("left"),10),width:parseInt(e.css("width"),10),height:parseInt(e.css("height"),10)})},s=function(){e.css({position:"absolute",top:"0px",left:"0px",width:t.width+"px",height:t.height+"px"}),i()};t.$on("updateSelection",function(i,s,o){s===t.editorId&&e.css(o)}),t.$on("dragStop",function(e,s,o){o.element.attr("editor-id")===t.editorId&&i()}),t.$on("resizeStop",function(e,s,o){o.element.attr("editor-id")===t.editorId&&i()}),s()}}})}(),function(){angular.module("pmImageEditor").factory("ResizableFactory",function(){var t=function(t){this._options=t,this._originalSize={width:0,height:0},this._originalPosition={top:0,left:0},this._originalMousePosition={top:0,left:0},this._position=this._originalPosition,this._size=this._originalSize,this._axis="se",this._ratio=1};return t.prototype.resizeStart=function(t,e){this.setOriginalMousePosition(t.screenY,t.screenX),this.setOriginalPosition(parseInt(e.css("top"),10)||0,parseInt(e.css("left"),10)||0),this.setParentSize(e.parent()),this.setOriginalSize(e),this._ratio=this._size.width/this._size.height;var i=t.target.className.match(/resizable-(se|sw|ne|nw|n|e|s|w)/i);this._axis=i&&i[1]?i[1]:"se",this.updateVirtualBoundaries()},t.prototype.getBoundaryData=function(t,e){var i=this.updateBoundaries(t-this._originalMousePosition.left,e-this._originalMousePosition.top);
return i=this.updateRatio(i),i=this.respectSize(i),this.updateSizeAndPosition(i),this.fitContainer(i)},t.prototype.updateBoundaries=function(t,e){var i=this._originalSize,s=this._originalPosition,o={e:function(t){return{width:i.width+t}},w:function(t){var e=i,o=s;return{left:o.left+t,width:e.width-t}},n:function(t,e){var o=i,r=s;return{top:r.top+e,height:o.height-e}},s:function(t,e){return{height:i.height+e}},se:function(t,e){return angular.extend(this.s.apply(this,arguments),this.e.apply(this,[t,e]))},sw:function(t,e){return angular.extend(this.s.apply(this,arguments),this.w.apply(this,[t,e]))},ne:function(t,e){return angular.extend(this.n.apply(this,arguments),this.e.apply(this,[t,e]))},nw:function(t,e){return angular.extend(this.n.apply(this,arguments),this.w.apply(this,[t,e]))}};return o[this._axis](t,e)},t.prototype.updateRatio=function(t){return angular.isNumber(t.height)?t.width=t.height*this._ratio:angular.isNumber(t.width)&&(t.height=t.width/this._ratio),"sw"===this._axis&&(t.left=this._position.left+(this._size.width-t.width),t.top=null),"nw"===this._axis&&(t.top=this._position.top+(this._size.height-t.height),t.left=this._position.left+(this._size.width-t.width)),t},t.prototype.updateSizeAndPosition=function(t){angular.isNumber(t.left)&&(this._position.left=t.left),angular.isNumber(t.top)&&(this._position.top=t.top),angular.isNumber(t.height)&&(this._size.height=t.height),angular.isNumber(t.width)&&(this._size.width=t.width)},t.prototype.updateVirtualBoundaries=function(){var t,e,i,s,o,r=this._options;o={minWidth:angular.isNumber(r.minWidth)?r.minWidth:0,maxWidth:angular.isNumber(r.maxWidth)?r.maxWidth:1/0,minHeight:angular.isNumber(r.minHeight)?r.minHeight:0,maxHeight:angular.isNumber(r.maxHeight)?r.maxHeight:1/0},this._ratio&&(t=o.minHeight*this._ratio,i=o.minWidth/this._ratio,e=o.maxHeight*this._ratio,s=o.maxWidth/this._ratio,t>o.minWidth&&(o.minWidth=t),i>o.minHeight&&(o.minHeight=i),e<o.maxWidth&&(o.maxWidth=e),s<o.maxHeight&&(o.maxHeight=s)),this._vBoundaries=o},t.prototype.respectSize=function(t){var e=this._vBoundaries,i=this._axis,s=angular.isNumber(t.width)&&e.maxWidth&&e.maxWidth<t.width,o=angular.isNumber(t.height)&&e.maxHeight&&e.maxHeight<t.height,r=angular.isNumber(t.width)&&e.minWidth&&e.minWidth>t.width,n=angular.isNumber(t.height)&&e.minHeight&&e.minHeight>t.height,a=this._originalPosition.left+this._originalSize.width,h=this._position.top+this._size.height,l=/sw|nw|w/.test(i),u=/nw|ne|n/.test(i);return r&&(t.width=e.minWidth),n&&(t.height=e.minHeight),s&&(t.width=e.maxWidth),o&&(t.height=e.maxHeight),r&&l&&(t.left=a-e.minWidth),s&&l&&(t.left=a-e.maxWidth),n&&u&&(t.top=h-e.minHeight),o&&u&&(t.top=h-e.maxHeight),t.width||t.height||t.left||!t.top?t.width||t.height||t.top||!t.left||(t.left=null):t.top=null,t},t.prototype.fitContainer=function(t){var e,i,s=!0;return this._position.left<0&&(this._size.width+=this._position.left,e=this._size.height,this._ratio&&(this._size.height=this._size.width/this._ratio,s=!1),this._position.left=0,"nw"===this._axis&&(this._position.top+=e-this._size.height)),this._position.top<0&&(this._size.height+=this._position.top,i=this._size.width,this._ratio&&(this._size.width=this._size.height*this._ratio,s=!1),this._position.top=0,"nw"===this._axis&&(this._position.left+=i-this._size.width)),this._position.left+this._size.width>=this._parentData.width&&(this._size.width=this._parentData.width-this._position.left,e=this._size.height,this._ratio&&(this._size.height=this._size.width/this._ratio,s=!1),("ne"===this._axis||"n"===this._axis)&&(this._position.top+=e-this._size.height)),this._position.top+this._size.height>=this._parentData.height&&(this._size.height=this._parentData.height-this._position.top,i=this._size.width,this._ratio&&(this._size.width=this._size.height*this._ratio,s=!1),"sw"===this._axis&&(this._position.left+=i-this._size.width)),s||(t.left=this._position.left,t.top=this._position.top,t.width=this._size.width,t.height=this._size.height),t},t.prototype.setOriginalSize=function(t){return this._originalSize={width:parseInt(t.css("width"),10)||t[0].clientWidth,height:parseInt(t.css("height"),10)||t[0].clientHeight},this._size=angular.copy(this._originalSize),this},t.prototype.getOriginalSize=function(){return this._originalSize},t.prototype.setParentSize=function(t){return this._parentData={width:parseInt(t.css("width"),10)||t[0].clientWidth,height:parseInt(t.css("height"),10)||t[0].clientHeight},this},t.prototype.getParentSize=function(){return this._parentData},t.prototype.setOriginalPosition=function(t,e){return this._originalPosition={top:t,left:e},this._position=angular.copy(this._originalPosition),this},t.prototype.getOriginalPosition=function(){return this._originalPosition},t.prototype.setOriginalMousePosition=function(t,e){return this._originalMousePosition={top:t,left:e},this},t.prototype.getOriginalMousePosition=function(){return this._originalMousePosition},t.prototype.setOption=function(t,e){return this._options[t]=e,this},t.prototype.getOption=function(t){return this._options[t]},t.prototype.getSize=function(){return this._size},t.prototype.getPosition=function(){return this._position},t.prototype.getRatio=function(){return this._ratio},t.prototype.getAxis=function(){return this._axis},t.prototype.getVirtualBoundaries=function(){return this._vBoundaries},t}).controller("ResizableController",["$scope","$document","$rootScope","ResizableFactory",function(t,e,i,s){t.resizableFactory=new s({minHeight:20,minWidth:20}),t.resizableUiParams=function(){return{element:t.element,position:t.resizableFactory.getPosition(),size:t.resizableFactory.getSize()}},t.resizableHandleMousedown=function(i){i.preventDefault(),i.stopPropagation(),t.resizableFactory.resizeStart(i,t.element),e.on("mousemove",t.resizableMousemove),e.on("mouseup",t.resizableMouseup)},t.resizableMousemove=function(e){var i=t.resizableFactory.getBoundaryData(e.screenX,e.screenY),s={};angular.forEach(i,function(t,e){null!==t&&(s[e]=t+"px")}),t.element.css(s)},t.resizableMouseup=function(s){e.unbind("mousemove",t.resizableMousemove),e.unbind("mouseup",t.resizableMouseup),i.$broadcast("resizeStop",s,t.resizableUiParams())}}]).directive("resizable",function(){return{restrict:"A",controller:"ResizableController",link:function(t,e){t.element=e,t.parentElement=e.parent(),e.css({position:"absolute"});var i="n,e,w,s,nw,ne,sw,se";i.split(",").forEach(function(i){var s=angular.element('<span class="resizable-'+i+' resizable-handle"></span>');e.append(s),s.on("mousedown",function(e){t.resizableHandleMousedown(e)})})}}})}(),function(){angular.module("pmImageEditor").factory("ImageHistoryFactory",function(){var t=function(t){this.editor=t,this.reset()};return t.prototype.reset=function(){this.items=[],this.historyIndex=-1},t.prototype.addItem=function(){this.items=this.items.slice(0,this.historyIndex+1),this.items.push({top:this.editor.top,left:this.editor.left,selection:angular.copy(this.editor.selection),wasCroppedForRotation:this.editor.wasCroppedForRotation,isCropped:this.editor.isCropped,hFlip:this.editor.hFlip,vFlip:this.editor.vFlip,rotation:this.editor.rotation,width:this.editor.width,height:this.editor.height}),this.historyIndex=this.items.length-1},t.prototype.canUndo=function(){return this.historyIndex>0},t.prototype.canRedo=function(){return this.historyIndex<this.items.length-1},t.prototype.redo=function(){this.canRedo()&&this.applyHistory(1)},t.prototype.undo=function(){this.canUndo()&&this.applyHistory(-1)},t.prototype.applyHistory=function(t){this.historyIndex+=t,angular.forEach(this.items[this.historyIndex],function(t,e){this.editor[e]=angular.isObject(t)?angular.copy(t):t},this)},t}).factory("ImageEditorFactory",["ImageHistoryFactory",function(t){var e=function(e){this.options=e,this.visibleWidth=+(e.visibleWidth||0),this.ratio=1,this.naturalWidth=0,this.naturalHeight=0,this.history=new t(this),this.resetTransformations()};return e.prototype.resetTransformations=function(){this.top=0,this.left=0,this.selection={top:0,left:0,width:this.options.selectionWidth||0,height:this.options.selectionHeight||0},this.selection.width&&this.selection.height&&(this.selection.ratio=this.selection.width/this.selection.height),this.wasCroppedForRotation=0,this.isCropped=!1,this.hFlip=!1,this.vFlip=!1,this.rotation=0,this.width=this.visibleWidth,this.height=this.width/this.ratio,this.history.reset(),this.history.addItem()},e.prototype.css=function(){var t=[];return this.vFlip&&t.push("scaleX(-1)"),this.hFlip&&t.push("scaleY(-1)"),this.rotation&&t.push("rotate("+90*this.rotation+"deg)"),{position:"absolute",top:this.top+"px",left:this.left+"px",width:this.width+"px",height:this.height+"px",transform:t.length?t.join(" "):"none"}},e.prototype.parentSize=function(){var t=this.isCropped?this.selection.ratio:this.ratio,e=this.visibleWidth;return{width:e,height:this.rotation%2===this.wasCroppedForRotation?e/t:e*t}},e.prototype.parentCss=function(){var t=this.parentSize();return{width:t.width+"px",height:t.height+"px"}},e.prototype.selectionCss=function(){return{top:this.selection.top+"px",left:this.selection.left+"px",width:this.selection.width+"px",height:this.selection.height+"px"}},e.prototype.initImageData=function(t,e){this.ratio=t/e,this.naturalWidth=t,this.naturalHeight=e,this.resetTransformations()},e.prototype.setVisibleWidth=function(t){return this.visibleWidth=parseInt(t,10),this.naturalWidth&&this.naturalHeight&&this.initImageData(this.naturalWidth,this.naturalHeight),this},e.prototype.setSelection=function(t){return this.selection=t,this.selection.ratio=t.width/t.height,this.history.addItem(),this},e.prototype.crop=function(){var t=this.selection,e=this.visibleWidth/t.width;this.top=(this.top-t.top)*e,this.left=(this.left-t.left)*e,this.width=this.width*e,this.height=this.width/this.ratio,this.isCropped=!0,this.wasCroppedForRotation=this.rotation%2;var i=this.parentSize();this.selection.top=0,this.selection.left=0,this.selection.width=i.width,this.selection.height=i.height,this.history.addItem()},e.prototype.horizontalFlip=function(){this.hFlip=!this.hFlip;var t=this.parentSize();this.top=t.height-this.height-this.top,this.history.addItem()},e.prototype.verticalFlip=function(){this.vFlip=!this.vFlip;var t=this.parentSize();this.left=t.width-this.width-this.left,this.history.addItem()},e.prototype.rotate=function(t){this.rotation+="cw"===t?1:-1,this.rotation=(this.rotation+4)%4;var e=this.parentSize(),i=e.height/this.visibleWidth;this.height=this.height*i,this.width=this.height*this.ratio;var s=this.top*i,o=this.left*i,r=e.width,n=e.height,a=this.width,h=this.height,l=o+a/2,u=s+h/2;"cw"===t?(this.left=o-l-u+r,this.top=s+l-u):(this.left=o-l+u,this.top=s-l-u+n),this.selection.top=0,this.selection.left=0,this.history.addItem()},e}]).controller("ImageEditorController",["$scope","ImageEditorFactory",function(t,e){t.editor=new e({selectionWidth:+t.selectionWidth,selectionHeight:+t.selectionHeight,visibleWidth:t.width}),t.editorId=String(Math.random()).replace("0.","editor-"),t.editor.setVisibleWidth(t.width),t.$on("editorButtonClick",function(e,i){switch(e.stopPropagation(),i.name){case"crop":t.editor.crop();break;case"rotate-cw":t.editor.rotate("cw");break;case"rotate-acw":t.editor.rotate("acw");break;case"flip-v":t.editor.verticalFlip();break;case"flip-h":t.editor.horizontalFlip();break;case"undo":t.editor.history.undo();break;case"redo":t.editor.history.redo()}t.updateEditorCss()}),t.updateEditorCss=function(){t.imageElement&&(t.imageElement.css(t.editor.css()),t.imageElement.parent().css(t.editor.parentCss()),t.$broadcast("updateSelection",t.editorId,t.editor.selectionCss()),t.updateHistoryButtons())},t.updateHistoryButtons=function(){t.$broadcast(t.editor.history.canUndo()?"enableButton":"disableButton",t.editorId,"undo"),t.$broadcast(t.editor.history.canRedo()?"enableButton":"disableButton",t.editorId,"redo")},t.$on("selectionChanged",function(e,i,s){i===t.editorId&&(e.stopPropagation(),t.editor.setSelection(s),t.updateEditorCss())}),t.$watch("width",function(e){t.editor.setVisibleWidth(e),t.updateEditorCss()})}]).directive("imageEditor",function(){return{restrict:"E",scope:{image:"@",width:"@",selectionWidth:"@",selectionHeight:"@"},controller:"ImageEditorController",template:'                    <div class="image-editor-canvas">                        <img ng-src="{{image}}" />                        <image-selection                             width="{{selectionWidth}}"                            height="{{selectionHeight}}"                            editor-id="{{editorId}}"                            draggable                            resizable                        ></image-selection>                    </div>                    <editor-panel editor-id="{{editorId}}"></editor-panel>',link:function(t,e){t.imageElement=e.find("img"),t.imageElement[0].onload=function(){t.editor.initImageData(this.naturalWidth,this.naturalHeight),t.updateEditorCss()}}}})}()}();